<div data-article-id="<%= tutorial._id %>"> 
    <h1><%= tutorial.title %></h1> 
    <p>Vistas: <span id="article-views"><%= tutorial.views %></span></p> 
    <hr>

    <section class="step">
        <h2>üí° Introducci√≥n</h2>
        <h2>¬øPor qu√© Ubuntu se Congela al Apagar con NVIDIA?</h2>
        <p>Este es un problema recurrente que afecta a muchos usuarios de **Ubuntu y derivados con hardware NVIDIA**. Al intentar apagar o reiniciar el sistema, la m√°quina se queda colgada en el logo de la BIOS o en una pantalla negra, sin completar el ciclo de apagado.</p>
        <p>El n√∫cleo del problema reside en que los **controladores propietarios de NVIDIA** a veces no liberan correctamente la tarjeta gr√°fica antes de que el kernel de Linux entregue el control al firmware (BIOS/UEFI) para el apagado final. Esto impide al firmware completar el proceso.</p>
        <p>A continuaci√≥n, te presentamos una gu√≠a con cuatro pasos probados, desde los m√°s sencillos hasta la soluci√≥n m√°s robusta a nivel de servicio.</p>
    </section>

    <section class="step">
        <h2>üîπ Paso 1: Actualizaci√≥n del Sistema y Drivers</h2>
        <p>Antes de modificar archivos del sistema, aseg√∫rate de que todo el software est√© actualizado. Las nuevas versiones del kernel o de los drivers de NVIDIA a menudo incluyen correcciones para este tipo de errores de liberaci√≥n de hardware.</p>
        
        <h3>Ejecuta los siguientes comandos en tu terminal:</h3>
        <pre><code>sudo apt update && sudo apt upgrade -y
sudo ubuntu-drivers autoinstall
</code></pre>
        <ul>
            <li>El primer comando actualiza el sistema.</li>
            <li>El segundo detecta e instala la versi√≥n m√°s reciente y adecuada del driver propietario NVIDIA para tu tarjeta.</li>
        </ul>
        <p>Despu√©s de este paso, **reinicia el equipo (`sudo reboot`) y prueba si el apagado funciona correctamente**. Si el problema persiste, contin√∫a con el paso 2.</p>
    </section>

    <section class="step">
        <h2>üîπ Paso 2: Revisi√≥n de la Configuraci√≥n de BIOS/UEFI</h2>
        <p>En ocasiones, ciertas caracter√≠sticas de arranque r√°pido del firmware (BIOS/UEFI) pueden interferir con la forma en que el sistema operativo maneja el apagado.</p>
        
        <h3>Acciones a realizar:</h3>
        <ol>
            <li>Reinicia el ordenador y accede a la configuraci√≥n de la **BIOS/UEFI** (la tecla suele ser $\text{Supr}$, $\text{F2}$, $\text{F10}$ o $\text{Esc}$ al arrancar).</li>
            <li>Busca y **desactiva** la opci√≥n **Fast Boot** (Arranque R√°pido).</li>
            <li>Si est√°s utilizando el driver propietario de NVIDIA, tambi√©n es recomendable **desactivar Secure Boot**, ya que a menudo genera conflictos de firma con los m√≥dulos del kernel de NVIDIA.</li>
        </ol>
        <p>Guarda los cambios, sal del $\text{BIOS}$ y prueba nuevamente el apagado.</p>
    </section>

    <section class="step">
        <h2>üîπ Paso 3: Ajustar Par√°metros del Kernel en GRUB</h2>
        <p>Si las soluciones anteriores fallan, podemos indicarle al kernel c√≥mo manejar el hardware al arrancar y al apagar, a√±adiendo par√°metros espec√≠ficos en el gestor de arranque GRUB.</p>

        <h3>Modificaci√≥n del archivo GRUB:</h3>
        <p>Edita el archivo de configuraci√≥n de GRUB:</p>
        <pre><code>sudo nano /etc/default/grub</code></pre>
        
        <p>Busca la l√≠nea:</p>
        <pre><code>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"</code></pre>

        <p>A√±ade uno de los siguientes par√°metros **(prueba uno por vez)** dentro de las comillas. El par√°metro m√°s efectivo para problemas de apagado de NVIDIA suele ser el primero:</p>
        <ul>
            <li><code>nvidia-drm.modeset=0</code> (Deshabilita el *kernel mode setting* de NVIDIA)</li>
            <li><code>acpi=force</code> (Fuerza al kernel a usar ACPI para la gesti√≥n de energ√≠a)</li>
            <li><code>nomodeset</code> (Desactiva la configuraci√≥n de modos de kernel. √ötil si la pantalla se queda negra al arrancar)</li>
        </ul>
        
        <p>Ejemplo con el primer par√°metro:</p>
        <pre><code>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nvidia-drm.modeset=0"</code></pre>

        <h3>Actualizar GRUB:</h3>
        <p>Guarda el archivo ($\text{Ctrl+O}$, $\text{Enter}$, $\text{Ctrl+X}$) y actualiza el gestor de arranque:</p>
        <pre><code>sudo update-grub</code></pre>
        <p>Reinicia el equipo y comprueba si el apagado se ha corregido.</p>
    </section>

    <section class="step">
        <h2>‚úÖ Paso 4: Crear un Servicio Systemd (La Soluci√≥n Definitiva)</h2>
        <p>Si nada de lo anterior funciona, la soluci√≥n m√°s robusta es forzar la descarga (liberaci√≥n) de los m√≥dulos del kernel de NVIDIA justo antes de que el sistema inicie el proceso de apagado, asegurando que la tarjeta gr√°fica no est√© siendo utilizada.</p>

        <h3>Creaci√≥n del archivo de servicio:</h3>
        <p>Crea el archivo de la unidad $\text{systemd}$ con $\text{nano}$:</p>
        <pre><code>sudo nano /etc/systemd/system/force-shutdown-nvidia.service</code></pre>
        
        <p>Copia el siguiente contenido **exactamente** como est√°. Este script usa $\text{modprobe -r}$ para remover los m√≥dulos `nvidia_drm` y `nvidia_modeset`:</p>
        <pre><code>[Unit]
Description=Force NVIDIA module unload before shutdown
Before=poweroff.target reboot.target halt.target

[Service]
Type=oneshot
ExecStart=/bin/true
ExecStop=/sbin/modprobe -r nvidia_drm nvidia_modeset nvidia
RemainAfterExit=yes

[Install]
WantedBy=halt.target reboot.target poweroff.target</code></pre>
        
        <h3>Activaci√≥n y prueba del servicio:</h3>
        <p>Guarda el archivo y luego activa el nuevo servicio:</p>
        <pre><code>sudo systemctl enable force-shutdown-nvidia.service</code></pre>
        <p>Reinicia el equipo y, finalmente, prueba a apagarlo. Esta soluci√≥n suele ser la definitiva.</p>
    </section>

    <section class="summary">
        <h2>üéØ Conclusi√≥n Final</h2>
        <ul>
            <li>La causa es la falta de liberaci√≥n de la tarjeta por parte del driver NVIDIA al finalizar la sesi√≥n.</li>
            <li>Siempre comienza por la **actualizaci√≥n de drivers y el sistema** (Paso 1).</li>
            <li>Si el problema persiste, ajusta los par√°metros del kernel en GRUB, priorizando **<code>nvidia-drm.modeset=0</code>** (Paso 3).</li>
            <li>La soluci√≥n m√°s fiable es la creaci√≥n del **servicio $\text{systemd}$** (Paso 4), que garantiza la descarga de los m√≥dulos NVIDIA antes de que el $\text{firmware}$ tome el control.</li>
        </ul>
        <p>Tu PC con Ubuntu ahora deber√≠a apagarse sin problemas y sin quedarse colgado en el logo de la $\text{BIOS}$.</p>
        <p>¬øQu√© te parece? ¬øNecesitas que te ayude a adaptar los scripts de aprovisionamiento si alguno de tus tutoriales lo requiere, o tienes otro post en mente?</p>
    </section>
    
    <!-- Secci√≥n de Comentarios -->
    <section id="comments-section">
        <h2>Comentarios</h2>
        <div class="comment-form-container step">
            <h3>Deja tu comentario</h3>
            <form id="comment-form">
                <div class="form-group">
                </div>
                <div class="form-group">
                    <label for="comment-text">Comentario:</label>
                    <textarea id="comment-text" rows="5" required></textarea>
                </div>
                <button type="submit" class="version-button">Enviar Comentario</button>
                <p id="comment-message" style="margin-top: 10px;"></p>
            </form>
        </div>

        <div id="comments-list-container" class="step">
            <h3>Comentarios (<span id="comments-count">0</span>)</h3>
            <div id="comments-list">
                <p>Cargando comentarios...</p>
            </div>
        </div>
    </section>
</div>